<ion-content [fullscreen]="true" class="main-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Fixed Top Bar -->
  <div class="fixed-top-bar">
    <div class="top-bar-content">
      <div class="top-bar-left">
        <span class="app-emoji">ðŸ’³</span>
        <span class="app-title">Payment History</span>
      </div>
      
      <div class="top-bar-right">
        <app-header-utils />
      </div>
    </div>
  </div>

  <!-- Content Container with Padding -->
  <div class="payments-container">
  <!-- Summary Card -->
  <ion-card class="summary-card">
    <ion-card-content>
      <div class="summary-content">
        <div class="summary-item">
          <ion-label class="summary-label">Total Payments</ion-label>
          <div class="summary-value">{{ payments.length }}</div>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-item">
          <ion-label class="summary-label">Total Amount Paid</ion-label>
          <div class="summary-value primary">{{ formatCurrency(totalPaid) }}</div>
        </div>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Filter Segment -->
  <ion-card class="filter-card">
    <ion-card-content>
      <ion-segment [value]="selectedFilter" (ionChange)="onFilterChange($event)">
        <ion-segment-button value="all">
          <ion-label>All</ion-label>
        </ion-segment-button>
        <ion-segment-button value="completed">
          <ion-label>Completed</ion-label>
        </ion-segment-button>
        <ion-segment-button value="pending">
          <ion-label>Pending</ion-label>
        </ion-segment-button>
      </ion-segment>
    </ion-card-content>
  </ion-card>

  <!-- Loading Spinner -->
  @if (loading) {
    <div class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading payments...</p>
    </div>
  }

  <!-- Empty State -->
  @if (!loading && filteredPayments.length === 0) {
    <ion-card class="empty-state">
      <ion-card-content>
        <ion-icon name="receipt-outline" class="empty-icon"></ion-icon>
        <h2>No Payments Found</h2>
        @if (selectedFilter === 'all') {
          <p>You haven't made any payments yet.</p>
        }
        @if (selectedFilter !== 'all') {
          <p>No {{ selectedFilter }} payments found.</p>
        }
      </ion-card-content>
    </ion-card>
  }

  <!-- Payment List -->
  @if (!loading && filteredPayments.length > 0) {
    <ion-list>
      @for (payment of filteredPayments; track payment.id) {
        <ion-card class="payment-card">
          <ion-card-header>
            <div class="payment-header">
              <div class="payment-header-left">
                <ion-icon [name]="getPaymentMethodIcon(payment.paymentMethod)" class="payment-icon"></ion-icon>
                <div class="payment-info">
                  <ion-card-title class="payment-amount">
                    {{ formatCurrency(payment.amount) }}
                  </ion-card-title>
                  <ion-note class="payment-reference">{{ payment.paymentReference }}</ion-note>
                </div>
              </div>
              <ion-badge [color]="getStatusColor(payment.status)">
                {{ payment.status }}
              </ion-badge>
            </div>
          </ion-card-header>

          <ion-card-content>
            <!-- Loan Information -->
            <div class="payment-detail-row">
              <ion-icon name="receipt-outline" class="detail-icon"></ion-icon>
              <div class="detail-content">
                <ion-label class="detail-label">Loan Number</ion-label>
                <ion-note class="detail-value">{{ payment.loanNumber }}</ion-note>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="payment-detail-row">
              <ion-icon [name]="getPaymentMethodIcon(payment.paymentMethod)" class="detail-icon"></ion-icon>
              <div class="detail-content">
                <ion-label class="detail-label">Payment Method</ion-label>
                <ion-note class="detail-value">{{ getPaymentMethodLabel(payment.paymentMethod) }}</ion-note>
              </div>
            </div>

            <!-- Payment Date -->
            <div class="payment-detail-row">
              <ion-icon name="calendar-outline" class="detail-icon"></ion-icon>
              <div class="detail-content">
                <ion-label class="detail-label">Payment Date</ion-label>
                <ion-note class="detail-value">
                  {{ formatDate(payment.paymentDate) }} at {{ formatTime(payment.createdAt) }}
                </ion-note>
              </div>
            </div>

            <!-- Amount Breakdown -->
            @if (payment.principalAmount > 0 || payment.interestAmount > 0) {
              <div class="breakdown-section">
                <ion-label class="breakdown-title">Amount Breakdown</ion-label>
                <div class="breakdown-grid">
                  @if (payment.principalAmount > 0) {
                    <div class="breakdown-item">
                      <ion-label class="breakdown-label">Principal</ion-label>
                      <ion-note class="breakdown-value">{{ formatCurrency(payment.principalAmount) }}</ion-note>
                    </div>
                  }
                  @if (payment.interestAmount > 0) {
                    <div class="breakdown-item">
                      <ion-label class="breakdown-label">Interest</ion-label>
                      <ion-note class="breakdown-value">{{ formatCurrency(payment.interestAmount) }}</ion-note>
                    </div>
                  }
                  @if (payment.penaltyAmount > 0) {
                    <div class="breakdown-item">
                      <ion-label class="breakdown-label">Penalty</ion-label>
                      <ion-note class="breakdown-value danger">{{ formatCurrency(payment.penaltyAmount) }}</ion-note>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Notes -->
            @if (payment.notes) {
              <div class="payment-notes">
                <ion-label class="notes-label">Notes</ion-label>
                <ion-note class="notes-text">{{ payment.notes }}</ion-note>
              </div>
            }
          </ion-card-content>
        </ion-card>
      }
    </ion-list>
  }
  </div>
</ion-content>
